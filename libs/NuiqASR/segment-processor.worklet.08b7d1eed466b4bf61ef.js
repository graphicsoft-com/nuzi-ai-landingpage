(()=>{"use strict";
/**
 * @license
 * Copyright 2019 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
const t=Symbol("Comlink.proxy"),e=Symbol("Comlink.endpoint"),n=Symbol("Comlink.releaseProxy"),r=Symbol("Comlink.finalizer"),s=Symbol("Comlink.thrown"),i=t=>"object"==typeof t&&null!==t||"function"==typeof t,a=new Map([["proxy",{canHandle:e=>i(e)&&e[t],serialize(t){const{port1:e,port2:n}=new MessageChannel;return o(t,e),[n,[n]]},deserialize:t=>(t.start(),function e(t,n){return d(t,[],n)}(t))}],["throw",{canHandle:t=>i(t)&&s in t,serialize({value:t}){let e;return e=t instanceof Error?{isError:!0,value:{message:t.message,name:t.name,stack:t.stack}}:{isError:!1,value:t},[e,[]]},deserialize(t){if(t.isError)throw Object.assign(new Error(t.value.message),t.value);throw t.value}}]]);function o(e,n=globalThis,i=["*"]){n.addEventListener("message",(function a(u){if(!u||!u.data)return;if(!function l(t,e){for(const n of t){if(e===n||"*"===n)return!0;if(n instanceof RegExp&&n.test(e))return!0}return!1}(i,u.origin))return void console.warn(`Invalid origin '${u.origin}' for comlink proxy`);const{id:h,type:f,path:d}=Object.assign({path:[]},u.data),m=(u.data.argumentList||[]).map(b);let g;try{const n=d.slice(0,-1).reduce(((t,e)=>t[e]),e),r=d.reduce(((t,e)=>t[e]),e);switch(f){case"GET":g=r;break;case"SET":n[d.slice(-1)[0]]=b(u.data.value),g=!0;break;case"APPLY":g=r.apply(n,m);break;case"CONSTRUCT":g=function s(e){return Object.assign(e,{[t]:!0})}(new r(...m));break;case"ENDPOINT":{const{port1:t,port2:n}=new MessageChannel;o(e,n),g=p(t,[t])}break;case"RELEASE":g=void 0;break;default:return}}catch(t){g={value:t,[s]:0}}Promise.resolve(g).catch((t=>({value:t,[s]:0}))).then((t=>{const[s,i]=S(t);n.postMessage(Object.assign(Object.assign({},s),{id:h}),i),"RELEASE"===f&&(n.removeEventListener("message",a),c(n),r in e&&"function"==typeof e[r]&&e[r]())})).catch((t=>{const[e,r]=S({value:new TypeError("Unserializable return value"),[s]:0});n.postMessage(Object.assign(Object.assign({},e),{id:h}),r)}))})),n.start&&n.start()}function c(t){(function e(t){return"MessagePort"===t.constructor.name})(t)&&t.close()}function u(t){if(t)throw new Error("Proxy has been released and is not useable")}function l(t){return v(t,{type:"RELEASE"}).then((()=>{c(t)}))}const h=new WeakMap,f="FinalizationRegistry"in globalThis&&new FinalizationRegistry((t=>{const e=(h.get(t)||0)-1;h.set(t,e),0===e&&l(t)}));function d(t,r=[],s=function(){}){let i=!1;const a=new Proxy(s,{get(e,s){if(u(i),s===n)return()=>{!function e(t){f&&f.unregister(t)}(a),l(t),i=!0};if("then"===s){if(0===r.length)return{then:()=>a};const e=v(t,{type:"GET",path:r.map((t=>t.toString()))}).then(b);return e.then.bind(e)}return d(t,[...r,s])},set(e,n,s){u(i);const[a,o]=S(s);return v(t,{type:"SET",path:[...r,n].map((t=>t.toString())),value:a},o).then(b)},apply(n,s,a){u(i);const o=r[r.length-1];if(o===e)return v(t,{type:"ENDPOINT"}).then(b);if("bind"===o)return d(t,r.slice(0,-1));const[c,l]=m(a);return v(t,{type:"APPLY",path:r.map((t=>t.toString())),argumentList:c},l).then(b)},construct(e,n){u(i);const[s,a]=m(n);return v(t,{type:"CONSTRUCT",path:r.map((t=>t.toString())),argumentList:s},a).then(b)}});return function o(t,e){const n=(h.get(e)||0)+1;h.set(e,n),f&&f.register(t,e,t)}(a,t),a}function m(t){const e=t.map(S);return[e.map((t=>t[0])),(n=e.map((t=>t[1])),Array.prototype.concat.apply([],n))];var n}const g=new WeakMap;function p(t,e){return g.set(t,e),t}function S(t){for(const[e,n]of a)if(n.canHandle(t)){const[r,s]=n.serialize(t);return[{type:"HANDLER",name:e,value:r},s]}return[{type:"RAW",value:t},g.get(t)||[]]}function b(t){switch(t.type){case"HANDLER":return a.get(t.name).deserialize(t.value);case"RAW":return t.value}}function v(t,e,n){return new Promise((r=>{const s=function i(){return new Array(4).fill(0).map((()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16))).join("-")}();t.addEventListener("message",(function e(n){n.data&&n.data.id&&n.data.id===s&&(t.removeEventListener("message",e),r(n.data))})),t.start&&t.start(),t.postMessage(Object.assign({id:s},e),n)}))}"undefined"!=typeof navigator&&navigator.userAgent.includes("Firefox");let y=48e3;if("undefined"!=typeof AudioContext){const t=new AudioContext;y=t.sampleRate,t.close()}!!globalThis.navigator&&/Mobi|Android/i.test(navigator.userAgent);const A="undefined"==typeof location?"":location.search,E="undefined"!=typeof process,w=(!E&&"undefined"!=typeof location&&location.pathname.includes("/dashboard"),"undefined"!=typeof AudioWorkletProcessor),P="undefined"!=typeof DedicatedWorkerGlobalScope||w,T=!E&&(P||w||"undefined"!=typeof navigator),M="undefined"!=typeof location&&("localhost"===location.hostname||location.href.startsWith("blob:http://localhost"));T&&"undefined"!=typeof location&&(location.host.includes("nuiq.com")||location.href.startsWith("blob:https://nuiq.com")||M&&location.port),"undefined"!=typeof location&&(location.host.includes("stage.nuiq.com")||location.href.startsWith("blob:https://stage.nuiq.com")),M||/debug(\=true)?($|&)/.test(A),"undefined"!=typeof navigator&&/Safari/i.test(navigator.userAgent)&&navigator.userAgent.includes("Chrome"),A.includes("useDevServer=true"),Math.PI;E&&Object.defineProperties(globalThis,{AudioWorkletProcessor:{value:class{},configurable:!0},registerProcessor:{value:()=>{},configurable:!0}});class k extends AudioWorkletProcessor{constructor(...t){super(...t),this.buffer=new Float32Array(256),this.count=0}get buffersPerBuffer(){return 2}process(t,e){if(!t||!e)return!0;const n=t[0][0],r=e[0][0];return!n||!r||(r.set(n),this.buffer.set(n,128*this.count),this.count+=1,this.count%=this.buffersPerBuffer,0===this.count&&this.onFrame(this.buffer),!0)}onFrame(t){}}const{log10:x}=Math,R=(t,e,n=.5)=>t*(1-n)+e*n,C=(t,e,n)=>e-t?(n-t)/(e-t):0;["upload","listen","summarize","telehealth"].map((t=>`finished-${t}-transcriptions`));const O={rms:0,peak:0};class L{constructor(t={}){this.currentTime=0,this.power=0,this.runningRMS=0,this.runningMinLevel=function e(t,n=.001,r=0){let s=Number.MIN_SAFE_INTEGER,i=null==t?0:1;const a=(e,a=n,o=r)=>{s=Math.max(s,e),null!=t||(t=e);const c=C(s-o*(s-t),t,e),u=t=e<t?e:R(t,e,a*(1-c));return i+=1,u};return Object.defineProperties(a,{value:{get:()=>t},numSamples:{get:()=>i},toString:{get:()=>()=>t}}),Object.assign(a,{addSample:a})}(),this.timeThresh=25,this.maxPower=0,this.lastSilenceStart=0,this.silencePrimed=!1,this.silencePrimedAt=0,this.lastActiveStart=0,this.isSilence=!0,this.wasSilence=!0,Object.assign(this,t)}get silenceTime(){return null!=this.lastSilenceStart?this.currentTime-this.lastSilenceStart:0}get activeTime(){return null!=this.lastActiveStart?this.currentTime-this.lastActiveStart:0}isSilent(t){var e;const{rms:n}=(t=>{let e=0,n=0;for(let r=0;r<t.length;r+=1){const s=t[r]*t[r];e+=s,s>n&&(n=s)}const r=e/t.length;return O.rms=Math.sqrt(r),O.peak=Math.sqrt(n),O})(t),r=null!==(e=this.currentTime)&&void 0!==e?e:performance.now();this.runningRMS=R(this.runningRMS,n,.2);const s=this.runningMinLevel(n);if(this.silencePrimed)return n>this.silencePrimedAt?(this.silencePrimed=!1,!0):(this.silencePrimedAt=n,!0);const i=this.isSilence=n<s+1e-5;i&&!this.wasSilence&&(this.lastSilenceStart=r),!i&&this.wasSilence&&(this.lastActiveStart=r),this.wasSilence=i;const a=null!=this.lastSilenceStart&&i&&r-this.lastSilenceStart>50,o=i&&a;return i||(this.lastSilenceStart=null),i&&(this.lastActiveStart=null),o&&(this.silencePrimed=!0,this.silencePrimedAt=n),o}}registerProcessor("segment-processor",class j extends k{constructor(...t){super(...t),this.Segment=t=>{const e=this;return{audio:t,get start(){return e.elapsedTime-t.length/sampleRate},get end(){return e.elapsedTime}}},this.currentBuffer=[],this.silenceDetector=new L({timeThresh:25}),this.maxChunkDuration=20,this.minChunkDuration=10,this.state="not-started",this.lastActive=!1,this.currentSegment=null,this.done=!1,this.elapsedTime=0,this.started=!1,this.index=0,this.id=`${Math.random()}`.replace(".",""),o(this,this.port)}set(t){Object.assign(this,t)}process(t,e){return!this.started||"paused"===this.state||(super.process(t,e),!0)}onFrame(t){this.buffer.set(t);const{silenceDetector:e}=this;e.currentTime=1e3*this.elapsedTime;const n=null!=this.currentSegment,r=this.currentSegment?this.currentSegment.end-this.currentSegment.start:0,s=r<this.minChunkDuration,i=n&&!s,a=r>=.9*this.maxChunkDuration,o=e.isSilent(this.buffer);return!a&&(!o||!i||!this.currentSegment)?(this.currentBuffer.push(...t),this.currentSegment||(this.currentSegment=this.Segment(this.currentBuffer),this.port.postMessage({method:"segment-start"}))):(this.next(),this.currentBuffer.length=0),this.elapsedTime+=256/sampleRate,!0}next(){if(this.currentSegment){const t=Float32Array.from(this.currentBuffer),e={method:"next",args:[p({audio:t,start:this.currentSegment.start,end:this.currentSegment.end,index:this.index},[t.buffer])]};this.port.postMessage(e),this.index+=1,this.currentSegment=null}}last(){if(this.currentSegment){const t=Float32Array.from(this.currentBuffer),e=p({audio:t,start:this.currentSegment.start,end:this.currentSegment.end,index:this.index},[t.buffer]);return this.index+=1,this.currentSegment=null,e}}})})();