(()=>{"use strict";
/**
 * @license
 * Copyright 2019 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
const t=Symbol("Comlink.proxy"),e=Symbol("Comlink.endpoint"),n=Symbol("Comlink.releaseProxy"),s=Symbol("Comlink.finalizer"),i=Symbol("Comlink.thrown"),r=t=>"object"==typeof t&&null!==t||"function"==typeof t,a=new Map([["proxy",{canHandle:e=>r(e)&&e[t],serialize(t){const{port1:e,port2:n}=new MessageChannel;return o(t,e),[n,[n]]},deserialize:t=>(t.start(),function e(t,n){return m(t,[],n)}(t))}],["throw",{canHandle:t=>r(t)&&i in t,serialize({value:t}){let e;return e=t instanceof Error?{isError:!0,value:{message:t.message,name:t.name,stack:t.stack}}:{isError:!1,value:t},[e,[]]},deserialize(t){if(t.isError)throw Object.assign(new Error(t.value.message),t.value);throw t.value}}]]);function o(e,n=globalThis,r=["*"]){n.addEventListener("message",(function a(u){if(!u||!u.data)return;if(!function l(t,e){for(const n of t){if(e===n||"*"===n)return!0;if(n instanceof RegExp&&n.test(e))return!0}return!1}(r,u.origin))return void console.warn(`Invalid origin '${u.origin}' for comlink proxy`);const{id:h,type:d,path:m}=Object.assign({path:[]},u.data),f=(u.data.argumentList||[]).map(b);let g;try{const n=m.slice(0,-1).reduce(((t,e)=>t[e]),e),s=m.reduce(((t,e)=>t[e]),e);switch(d){case"GET":g=s;break;case"SET":n[m.slice(-1)[0]]=b(u.data.value),g=!0;break;case"APPLY":g=s.apply(n,f);break;case"CONSTRUCT":g=function i(e){return Object.assign(e,{[t]:!0})}(new s(...f));break;case"ENDPOINT":{const{port1:t,port2:n}=new MessageChannel;o(e,n),g=p(t,[t])}break;case"RELEASE":g=void 0;break;default:return}}catch(t){g={value:t,[i]:0}}Promise.resolve(g).catch((t=>({value:t,[i]:0}))).then((t=>{const[i,r]=S(t);n.postMessage(Object.assign(Object.assign({},i),{id:h}),r),"RELEASE"===d&&(n.removeEventListener("message",a),c(n),s in e&&"function"==typeof e[s]&&e[s]())})).catch((t=>{const[e,s]=S({value:new TypeError("Unserializable return value"),[i]:0});n.postMessage(Object.assign(Object.assign({},e),{id:h}),s)}))})),n.start&&n.start()}function c(t){(function e(t){return"MessagePort"===t.constructor.name})(t)&&t.close()}function u(t){if(t)throw new Error("Proxy has been released and is not useable")}function l(t){return A(t,{type:"RELEASE"}).then((()=>{c(t)}))}const h=new WeakMap,d="FinalizationRegistry"in globalThis&&new FinalizationRegistry((t=>{const e=(h.get(t)||0)-1;h.set(t,e),0===e&&l(t)}));function m(t,s=[],i=function(){}){let r=!1;const a=new Proxy(i,{get(e,i){if(u(r),i===n)return()=>{!function e(t){d&&d.unregister(t)}(a),l(t),r=!0};if("then"===i){if(0===s.length)return{then:()=>a};const e=A(t,{type:"GET",path:s.map((t=>t.toString()))}).then(b);return e.then.bind(e)}return m(t,[...s,i])},set(e,n,i){u(r);const[a,o]=S(i);return A(t,{type:"SET",path:[...s,n].map((t=>t.toString())),value:a},o).then(b)},apply(n,i,a){u(r);const o=s[s.length-1];if(o===e)return A(t,{type:"ENDPOINT"}).then(b);if("bind"===o)return m(t,s.slice(0,-1));const[c,l]=f(a);return A(t,{type:"APPLY",path:s.map((t=>t.toString())),argumentList:c},l).then(b)},construct(e,n){u(r);const[i,a]=f(n);return A(t,{type:"CONSTRUCT",path:s.map((t=>t.toString())),argumentList:i},a).then(b)}});return function o(t,e){const n=(h.get(e)||0)+1;h.set(e,n),d&&d.register(t,e,t)}(a,t),a}function f(t){const e=t.map(S);return[e.map((t=>t[0])),(n=e.map((t=>t[1])),Array.prototype.concat.apply([],n))];var n}const g=new WeakMap;function p(t,e){return g.set(t,e),t}function S(t){for(const[e,n]of a)if(n.canHandle(t)){const[s,i]=n.serialize(t);return[{type:"HANDLER",name:e,value:s},i]}return[{type:"RAW",value:t},g.get(t)||[]]}function b(t){switch(t.type){case"HANDLER":return a.get(t.name).deserialize(t.value);case"RAW":return t.value}}function A(t,e,n){return new Promise((s=>{const i=function r(){return new Array(4).fill(0).map((()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16))).join("-")}();t.addEventListener("message",(function e(n){n.data&&n.data.id&&n.data.id===i&&(t.removeEventListener("message",e),s(n.data))})),t.start&&t.start(),t.postMessage(Object.assign({id:i},e),n)}))}"undefined"!=typeof navigator&&navigator.userAgent.includes("Firefox");let v=48e3;if("undefined"!=typeof AudioContext){const t=new AudioContext;v=t.sampleRate,t.close()}const y=256,x=(!!globalThis.navigator&&/Mobi|Android/i.test(navigator.userAgent),"undefined"==typeof location?"":location.search),T="undefined"!=typeof process,E=(!T&&"undefined"!=typeof location&&location.pathname.includes("/dashboard"),"undefined"!=typeof AudioWorkletProcessor),w="undefined"!=typeof DedicatedWorkerGlobalScope||E,k=!T&&(w||E||"undefined"!=typeof navigator),P="undefined"!=typeof location&&("localhost"===location.hostname||location.href.startsWith("blob:http://localhost")),L=k&&"undefined"!=typeof location&&(location.host.includes("nuiq.com")||location.href.startsWith("blob:https://nuiq.com")||P&&"3004"!==location.port),M=("undefined"!=typeof location&&(location.host.includes("stage.nuiq.com")||location.href.startsWith("blob:https://stage.nuiq.com")),!!T||L&&!P),R=P||/debug(\=true)?($|&)/.test(x);"undefined"!=typeof navigator&&/Safari/i.test(navigator.userAgent)&&navigator.userAgent.includes("Chrome"),x.includes("useDevServer=true"),Math.PI;T&&Object.defineProperties(globalThis,{AudioWorkletProcessor:{value:class{},configurable:!0},registerProcessor:{value:()=>{},configurable:!0}});class C extends AudioWorkletProcessor{constructor(...t){super(...t),this.buffer=new Float32Array(y),this.count=0}get buffersPerBuffer(){return 2}process(t,e){if(!t||!e)return!0;const n=t[0][0],s=e[0][0];return!n||!s||(s.set(n),this.buffer.set(n,128*this.count),this.count+=1,this.count%=this.buffersPerBuffer,0===this.count&&this.onFrame(this.buffer),!0)}onFrame(t){}}const{log10:D}=Math,O=(t,e,n=.5)=>t*(1-n)+e*n,j=(t,e,n)=>e-t?(n-t)/(e-t):0;["upload","listen","summarize","telehealth"].map((t=>`finished-${t}-transcriptions`));const F={rms:0,peak:0};class N{constructor(t={}){this.currentTime=0,this.power=0,this.runningRMS=0,this.runningMinLevel=function e(t,n=.001,s=0){let i=Number.MIN_SAFE_INTEGER,r=null==t?0:1;const a=(e,a=n,o=s)=>{i=Math.max(i,e),null!=t||(t=e);const c=j(i-o*(i-t),t,e),u=t=e<t?e:O(t,e,a*(1-c));return r+=1,u};return Object.defineProperties(a,{value:{get:()=>t},numSamples:{get:()=>r},toString:{get:()=>()=>t}}),Object.assign(a,{addSample:a})}(),this.timeThresh=25,this.maxPower=0,this.lastSilenceStart=0,this.silencePrimed=!1,this.silencePrimedAt=0,this.lastActiveStart=0,this.isSilence=!0,this.wasSilence=!0,Object.assign(this,t)}get silenceTime(){return null!=this.lastSilenceStart?this.currentTime-this.lastSilenceStart:0}get activeTime(){return null!=this.lastActiveStart?this.currentTime-this.lastActiveStart:0}isSilent(t){var e;const{rms:n}=(t=>{let e=0,n=0;for(let s=0;s<t.length;s+=1){const i=t[s]*t[s];e+=i,i>n&&(n=i)}const s=e/t.length;return F.rms=Math.sqrt(s),F.peak=Math.sqrt(n),F})(t),s=null!==(e=this.currentTime)&&void 0!==e?e:performance.now();this.runningRMS=O(this.runningRMS,n,.2);const i=this.runningMinLevel(n);if(this.silencePrimed)return n>this.silencePrimedAt?(this.silencePrimed=!1,!0):(this.silencePrimedAt=n,!0);const r=this.isSilence=n<i+1e-5;r&&!this.wasSilence&&(this.lastSilenceStart=s),!r&&this.wasSilence&&(this.lastActiveStart=s),this.wasSilence=r;const a=null!=this.lastSilenceStart&&r&&s-this.lastSilenceStart>50,o=r&&a;return r||(this.lastSilenceStart=null),r&&(this.lastActiveStart=null),o&&(this.silencePrimed=!0,this.silencePrimedAt=n),o}}const z=M&&!R,W=Object.fromEntries(["log","info","warn","error"].map((t=>[t,z?()=>{}:(...e)=>console[t](...(t=>t.map((t=>"string"==typeof t?t.trim():t)))(e))]))),I={};z||Object.assign(globalThis,{debugData:I});const B=z?()=>{}:(t,e)=>{var n;return null!==(n=I[t])&&void 0!==n||(I[t]=[]),I[t].push(e),W.log(t,e)},q=Object.assign(W.log,{data:B}),{info:G,warn:H,error:$}=W;registerProcessor("segment-processor",class _ extends C{constructor(...t){super(...t),this.Segment=t=>{const e=this;return{audio:t,get start(){return e.elapsedTime-t.length/sampleRate},get end(){return e.elapsedTime}}},this.currentBuffer=[],this.silenceDetector=new N({timeThresh:25}),this.maxChunkDuration=20,this.minChunkDuration=10,this.state="not-started",this.lastActive=!1,this.currentSegment=null,this.done=!1,this.elapsedTime=0,this.started=!1,this.index=0,this.id=`${Math.random()}`.replace(".",""),o(this,this.port),q("using segment-processor")}set(t){Object.assign(this,t)}process(t,e){return!this.started||"paused"===this.state||(super.process(t,e),!0)}onFrame(t){this.buffer.set(t);const{silenceDetector:e}=this;e.currentTime=1e3*this.elapsedTime;const n=null!=this.currentSegment,s=this.currentSegment?this.currentSegment.end-this.currentSegment.start:0,i=s<this.minChunkDuration,r=n&&!i,a=s>=.9*this.maxChunkDuration,o=e.isSilent(this.buffer);return!a&&(!o||!r||!this.currentSegment)?(this.currentBuffer.push(...t),this.currentSegment||(this.currentSegment=this.Segment(this.currentBuffer),this.port.postMessage({method:"segment-start"}))):(this.next(),this.currentBuffer.length=0),this.elapsedTime+=y/sampleRate,!0}next(){if(this.currentSegment){const t=Float32Array.from(this.currentBuffer),e={method:"next",args:[p({audio:t,start:this.currentSegment.start,end:this.currentSegment.end,index:this.index},[t.buffer])]};this.port.postMessage(e),this.index+=1,this.currentSegment=null}}last(){if(this.currentSegment){const t=Float32Array.from(this.currentBuffer),e=p({audio:t,start:this.currentSegment.start,end:this.currentSegment.end,index:this.index},[t.buffer]);return this.index+=1,this.currentSegment=null,e}}}),registerProcessor("realtime-segment-processor",class U extends C{constructor(...t){super(...t),this.silenceDetector=new N({timeThresh:12.5}),this.maxChunkDuration=5,this.minChunkDuration=2.5,this.minSendInterval=.5,this.lastActive=!1,this.done=!1,this.elapsedTime=0,this.started=!1,this.index=0,this.lastSegmentSentAtIndex=0,this.lastAudioAccumulatedSinceLastSend=[],this.audioAccumulatedSinceLastSend=[],this.id=`${Math.random()}`.replace(".",""),o(this,this.port),q("using realtime-segment-processor")}set(t){Object.assign(this,t)}process(t,e){return!this.started||(super.process(t,e),!0)}onFrame(t){this.buffer.set(t);const{silenceDetector:e}=this;e.currentTime=1e3*this.elapsedTime;const n=this.audioAccumulatedSinceLastSend.length/sampleRate,s=e.isSilent(this.buffer);if(n>this.minSendInterval){const t=this.audioAccumulatedSinceLastSend.length/sampleRate,e=this.lastAudioAccumulatedSinceLastSend.length/sampleRate,n=t>=this.minChunkDuration||t+e>this.maxChunkDuration?this.audioAccumulatedSinceLastSend:[...this.lastAudioAccumulatedSinceLastSend,...this.audioAccumulatedSinceLastSend],i=n.length/sampleRate,r=i<this.minChunkDuration,a=i>this.maxChunkDuration;(s&&!r||a)&&(this.next(n),this.lastAudioAccumulatedSinceLastSend=[...this.audioAccumulatedSinceLastSend],this.audioAccumulatedSinceLastSend=[])}return this.elapsedTime+=y/sampleRate,this.audioAccumulatedSinceLastSend.push(...t),!0}next(t=[]){const e=Float32Array.from(t),n={method:"next",args:[p({audio:e,start:this.elapsedTime-t.length/sampleRate,end:this.elapsedTime,index:this.index},[e.buffer])]};this.port.postMessage(n),this.index+=1}last(){return this.next([...this.lastAudioAccumulatedSinceLastSend,...this.audioAccumulatedSinceLastSend])}})})();